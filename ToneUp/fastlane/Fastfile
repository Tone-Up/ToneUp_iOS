# fastlane/Fastfile

default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do

    create_keychain(
      name: ENV["KEYCHAIN_NAME"],
      password: ENV["KEYCHAIN_PASSWORD"],
      timeout: 1800,
      default_keychain: true,
      unlock: true,
      lock_when_sleeps: false
    )

    # App Store Connect API ì¸ì¦
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
    )

    # ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ê°€ì ¸ì˜¤ê¸°
    match(
      type: "appstore",
      keychain_name: ENV["KEYCHAIN_NAME"],
      keychain_password: ENV["KEYCHAIN_PASSWORD"]
    )

    # TestFlight ìµœì‹  ë¹Œë“œ ë„˜ë²„ ê°€ì ¸ì˜¤ê¸°
    latest_build_number = latest_testflight_build_number(
      app_identifier: "com.jun.ToneUp",
      username: ENV["APPLE_DEV_USERNAME"]
    )

    # ë¹Œë“œ ë²ˆí˜¸ ì¦ê°€
    increment_build_number(
      build_number: latest_build_number + 1,
      xcodeproj: "ToneUp.xcodeproj"
    )

    update_project_provisioning(
      xcodeproj: "ToneUp.xcodeproj",
      target_filter: "ToneUp",
      profile: ENV["sigh_com.jun.ToneUp_appstore_profile-path"],
      code_signing_identity: "Apple Distribution"
    )

    # ì•± ë¹Œë“œ
    build_app(
      project: "ToneUp.xcodeproj",
      scheme: "ToneUp",
      clean: true,
      export_method: "app-store",
      output_directory: "./build",
      include_bitcode: false,
    )

    # TestFlight ì—…ë¡œë“œ
    upload_to_testflight(
      username: ENV["APPLE_DEV_USERNAME"],
      app_identifier: "com.jun.ToneUp"
    )
  end

  error do |lane, exception, options|
    UI.error("ì—ëŸ¬ ë°œìƒ ğŸ’¥ : #{exception}")
  end
end
